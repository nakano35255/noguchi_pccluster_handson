# 野口研究室PCクラスターの使用法

## ログイン

野口研究室は３つの計算機サーバーを持っている。
それぞれ以下のIPアドレスとが割り当てられている。

- **nok00.issp.u-tokyo.ac.jp**
  - IPアドレス: 192.168.93.166
- **nog00.issp.u-tokyo.ac.jp**
  - IPアドレス: 192.168.93.196
- **nox00.issp.u-tokyo.ac.jp**
  - IPアドレス: 192.168.93.202

`nox00`は古い計算機なので基本的に用いず、`nok00`と`nog00`を用いること。

terminalから以下のコマンドでそれぞれのサーバーにログインできる。

```sh
ssh username@192.168.93.166
```
usernameは登録したユーザー名であり、IPアドレス部分はログインしたいサーバーごとに変更する。

上記のコマンドを打つと、以下のようにパスワードが求められるので登録済みのパスワードを入力する。

```sh
ssh username@192.168.93.166
username@192.168.93.166's password: 
Last login: Wed Jul 10 12:43:40 2024 from 192.168.00.000
```
するとログインできる。


## コンパイルとジョブの投入

ここではPCクラスタ上でどのように計算を実行するかを説明する。
特にC++で書かれたプログラムの投げ方を説明する。

最初にテスト用のコードを書こう。
```sh
mkdir handson
cd handson
```
として、handsonフォルダに移動する。そして、
```sh
vim test.cpp
```
でtest.cppを開き、以下を書き込む。
```sh

```

このプログラムの実行するにはコンパイルする必要がある。野口研PCクラスタでは、Cプログラムの場合をC++プログラムの場合を用いる。
```sh
mpicxx -O3 -o out.exe test.cpp
```

PCクラスタやスパコンのような共有計算資源では、プログラムをジョブスクリプトを用いて計算機に投げ、順番待ちをする。この順番待ちの列を「キュー（Queue）」と呼ぶ。プログラムをバッチジョブとして実行するためには、ジョブスケジューラに対してどのような計算資源を要求するか、どのようにプログラムを実行するかを指定する必要がある。バッチジョブは、あらかじめ定義された一連の処理を一括して実行するジョブのことである。ジョブスクリプトは、特殊なコメント欄を持つシェルスクリプトで、これを用いてジョブスケジューラに指示を与える。

実際にジョブスクリプトを書いてみる。
```sh
vim test.sh
```
を入力しtest.shを開き、以下を書き込む。
```sh
#!/bin/bash

#SBATCH -p defq
#SBATCH -N 1
#SBATCH -n 1
#SBATCH -c 1

srun -n 1 -N 1 ./a.out &

wait
```

最初の`#!`で始まる行はシバン(shebang)と呼ばれ、このスクリプトを処理するシェルを指定する。

次行からの`#SBATCH`で始まる行が、ジョブスケジューラ(Slurm)への指示である。それぞれの意味は以下の通り。

* `-p defq` 計算資源(パーティション)の指定で、ここでは`defq`を指定している。（基本的に`defq`を用いれば良い。）
* `-N 1` 要求ノード数(ここでは1ノード、基本的に1ノードで良い。)
* `-n 1` 利用プロセス数(ここでは1プロセス、mpi並列を用いた並列化を行わない限り1プロセスで良い。)
* `-c 1` 利用スレッド数(ここでは1スレッド、openmpを用いた並列化を行わない限り1スレッドで良い。)

`srun`は、Slurmで管理されたシステムにおいて並列ジョブを実行するためのコマンドである。このジョブに割り当てられた計算資源を確認し、どのプロセスをどの計算資源に割り振るかを自動的に決定する。


このシェルスクリプトをジョブとして投入するには`sbatch`コマンドを使う。

```sh
sbatch test.sh
```

ジョブを投入した結果、ジョブIDが割り振られる。ジョブの状態は`squeue`コマンドで知ることができる。

```sh
squeue
```

例えば以下のような表示がでる。

```txt
            JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
            21122      defq    test.sh  nakano R       0:03      1 nog01
```

それぞれの情報の意味は以下の通り。

* ジョブID(JOBID)として272905が割り振られた
* 計算リソース(PARTITION)は`defq`を要求している
* シェルスクリプトのファイル名(NAME)は`test.sh`である
* 状態(status, ST)は実行中(R)である
* 実行開始からの時間(TIME)は3秒(0:03)
* 要求ノード数(NODES)は1である
* 実行ノードリスト(NODELIST)、もしくは待ち状態ならその理由(REASON)

基本的に野口研PCクラスタはそんなに規模が大きくないので、並列計算を行わずに1プロセス1スレッドで長い時間必要な計算を流すのが良い。