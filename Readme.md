# 野口研究室PCクラスターの使用法

## ログイン

野口研究室は３つの計算機サーバーを持っている。
それぞれ以下のIPアドレスとが割り当てられている。

- **nok00.issp.u-tokyo.ac.jp**
  - IPアドレス: 192.168.93.166
- **nog00.issp.u-tokyo.ac.jp**
  - IPアドレス: 192.168.93.196
- **nox00.issp.u-tokyo.ac.jp**
  - IPアドレス: 192.168.93.202

`nox00`は古い計算機なので基本的に用いず、`nok00`と`nog00`を用いること。

terminalから以下のコマンドでそれぞれのサーバーにログインできる。

```sh
ssh username@192.168.93.166
```
usernameは登録したユーザー名であり、IPアドレス部分はログインしたいサーバーごとに変更する。

上記のコマンドを打つと、以下のようにパスワードが求められるので登録済みのパスワードを入力する。

```sh
ssh username@192.168.93.166
username@192.168.93.166's password: 
Last login: Wed Jul 10 12:43:40 2024 from 192.168.00.000
```
するとログインできる。


## コンパイルとジョブの投入

ここではPCクラスタ上でどのように計算を実行するかを説明する。
特にc言語/C++で書かれたプログラムの投げ方を説明する。

最初にテスト用のコードを書こう。
```sh
mkdir handson
cd handson
```
として、handsonフォルダに移動する。そして、
```sh
vim test.cc
```
でtest.ccを開き、以下を書き込む。
```sh
#include <iostream>

int main() {
  std::cout << "Hello, World!!" << std::endl;
}
```

このプログラムの実行するにはコンパイルする必要がある。
nog00にはインテルコンパイラがインストールされているので、Cプログラムの場合iccを、C++プログラムの場合icpcを用いる。

nok00にはインテルコンパイラがインストールされていないので、Cプログラムの場合gccを、C++プログラムの場合g++を用いる。
```sh
icpc -O3 -o out.exe test.cc
```

PCクラスタやスパコンのような共有計算資源では、プログラムをジョブスクリプトを用いて計算機に投げ、順番待ちをする。この順番待ちの列を「キュー（Queue）」と呼ぶ。
ジョブスクリプトは特殊なコメント欄を持つシェルスクリプトで、ジョブスケジューラに対してどのような計算資源を要求するかやどのようにプログラムを実行するかの指示を与える。
このような、あらかじめ定義された一連の処理を一括して実行するジョブのことを「バッチジョブ（Batch job）」と呼ぶ。

実際にジョブスクリプトを書いてみる。
```sh
vim test.sh
```
を入力しtest.shを開き、以下を書き込む。
```sh
#!/bin/bash

#SBATCH -p defq
#SBATCH -N 1
#SBATCH -n 1
#SBATCH -c 1

srun ./out.exe
```

最初の`#!`で始まる行はシバン(shebang)と呼ばれ、このスクリプトを処理するシェルを指定する。

次行からの`#SBATCH`で始まる行が、ジョブスケジューラ(Slurm)への指示である。それぞれの意味は以下の通り。

* `-p defq` 計算資源(パーティション)の指定で、ここでは`defq`を指定している。（nog00では、基本的に`defq`を用いれば良く、nok00では`nok`を用いれば良い。）
* `-N 1` 要求ノード数(ここでは1ノード、基本的に1ノードで良い。)
* `-n 1` 利用プロセス数(ここでは1プロセス、mpi並列を用いた並列化を行わない限り1プロセスで良い。)
* `-c 1` 利用スレッド数(ここでは1スレッド、openmpを用いた並列化を行わない限り1スレッドで良い。)

`srun`は、Slurmで管理されたシステムにおいて並列ジョブを実行するためのコマンドである。このジョブに割り当てられた計算資源を確認し、どのプロセスをどの計算資源に割り振るかを自動的に決定する。
`srun`以下に自分が実行したいコマンドを書き込む。

このシェルスクリプトをジョブとして投入するには`sbatch`コマンドを使う。

```sh
sbatch test.sh
```

ジョブを投入した結果、ジョブIDが割り振られる。ジョブの状態は`squeue`コマンドで知ることができる。

```sh
squeue
```

例えば以下のような表示がでる。

```txt
            JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
            21122      defq    test.sh  nakano R       0:03      1 nog01
```

それぞれの情報の意味は以下の通り。

* ジョブID(JOBID)として272905が割り振られた
* 計算リソース(PARTITION)は`defq`を要求している
* シェルスクリプトのファイル名(NAME)は`test.sh`である
* 状態(status, ST)は実行中(R)である
* 実行開始からの時間(TIME)は3秒(0:03)
* 要求ノード数(NODES)は1である
* 実行ノードリスト(NODELIST)、もしくは待ち状態ならその理由(REASON)

間違ったジョブを投入してしまった場合は
```sh
scancel JOBID
```
でジョブを削除する。上の場合は
```sh
scancel 21122
```
となる。

計算が終了すると、slurm-21122.outのようなファイル名のファイルが生成されている。
```sh
ls
out.exe  slurm-21122.out  test.c  test.sh
```
slurm-21122.outの中に
```sh
Hello, World!!
```
と書かれていれば、正常に計算が実行されたことになる。


## 野口さん作成binフォルダの使用
工事中
